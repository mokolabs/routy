<!DOCTYPE html>
<html>
  <head>
    <title>BMI Javascript Route Tester</title>
    <script src="http://code.jquery.com/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript" type="text/javascript"></script>
    <script>
    
      $(document).ready(function(){
        $('form').submit(function() {
          
          // Grab inbound route
          var inbound = "http://" + window.location.host + $("#inbound").val();
          
          // Parse route
          var url = $.url(inbound);
          var source = url.attr('source');
          var relative = url.attr('relative');
          var path = url.attr('path');
          var query = url.attr('query');
          var segment_count = path.split(/\//).length - 1;
          var segment = new Array();
          var i = 1;
          while (i <= segment_count) {
            segment[i] = url.segment(i);
            i++;
          }
          
          // Load routes feed
          if (path != '') {
            
            $.getJSON('/routes.json', function(data) {
              var match = '';
              var redirect = '';
              var matcher = "/" + segment[1] + "/" + segment[2];
              
              // Look for match
              $.each(data, function(i, val) {
                
                // Simple route
                if (path == val.route.inbound) {
                  
                  match = "Match found (bmi.com" + val.route.inbound + " ----> /mobile" + val.route.outbound + ")";
                  redirect = val.route.outbound;
                  
                  if (query != '') {
                    redirect = redirect + "?" + query;
                  }
                  
                  return false;

                // Wildcard route                  
                } else if (matcher == val.route.inbound) {

                  match = "Match found (bmi.com" + val.route.inbound + " ----> /mobile" + val.route.outbound + ")";
                  redirect = val.route.outbound + "/" + segment[3]

                  if (query != '') {
                    redirect = redirect + "?" + query;
                  }
                  
                  return false;

                // If no match found
                } else {
                  console.log("No match found for " + val.route.inbound);
                }
                                
              });

              // Show success or failure message
              if (match != '') {
                $("#message").html(match);
                $("#redirect").html("Redirecting to... /mobile" + redirect);
              } else {
                $("#message").html("No match found");
              }

            });
            
          }
          
          return false;
        });
      });
      
    </script>
    <style>
      
      body {
        font-family: Helvetica;
        margin: 30px;
      }
      
      input[type=text] {
        font-size: 24px;
        width: 600px;
        border-radius: 6px;
      }
    
      input[type=submit] {
        font-size: 24px;
      }
      
      #nav {
        color: #bbb;
        margin: 12px 0;
      }
      
      #nav a {
        color: #999;
        text-decoration: none;
      }
      
      #nav a:hover {
        text-decoration: underline;
      }
      
    </style>
  </head>
</html>
<body>
  
  <div id="nav">
    <a href="/">Route Builder</a> | 
    <a href="/tester">Route Tester</a>  
  </div>
  
  <h1>Route Tester</h1>
  
  <form action="/tester" method="post">
    <input id="inbound" type="text" name="inbound" placeholder="Inbound" />
    <br />
    <input type="submit" value="Test Route" />
  </form>
  
  <p id="message"></p>
  <p id="redirect"></p>
  
  <script>
  
    // if ($("#inbound").val() != '') {
    //   document.write("<p><b>source:</b>&nbsp;" + source + "</p>");  
    //   document.write("<p><b>path:</b>&nbsp;" + path + "</p>");
    //   document.write("<p><b>segments:</b>&nbsp;" + segment_count + "</p>");
    // 
    //   for(var i = 1; i < segment.length; i++) {
    //    document.write("<p>Segment " + i + ": " + segment[i]);
    //   }
    // }
      
  </script>
  
</body>







